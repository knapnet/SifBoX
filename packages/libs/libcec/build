#!/bin/sh

. config/options
get_meta $1

cd $PKG_BUILD_DIR

if [ "$TARGET_MACHINE" = cubox ]; then
   EXTRA_CMAKE_OPTS="-DHAVE_IMX_API=1"
else
   EXTRA_CMAKE_OPTS="-DHAVE_IMX_API=0"
fi

if [ "$TARGET_MACHINE" = raspberrypi ] || \
   [ "$TARGET_MACHINE" = raspberrypi2 ]; then
   export CXXFLAGS="$CXXFLAGS \
   -I$SYSROOT_PREFIX/sysroot/usr/local/include/interface/vcos/pthreads/ \
   -I$SYSROOT_PREFIX/sysroot/usr/local/include/interface/vmcs_host/linux \
   -I$SYSROOT_PREFIX/sysroot/usr/local/include/interface/vchiq_arm"

   # detecting RPi support fails without -lvchiq_arm
   #export LDFLAGS="$LDFLAGS -lvchiq_arm"
fi
mkdir build || true && cd build
cmake -DCMAKE_TOOLCHAIN_FILE=$CMAKE_CONF \
      -DBUILD_SHARED_LIBS=1 \
      -DSKIP_PYTHON_WRAPPER:STRING=1 \
      -DCMAKE_INSTALL_PREFIX=/usr \
      -DCMAKE_INSTALL_LIBDIR=/usr/lib \
      -DCMAKE_INSTALL_LIBDIR_NOARCH=/usr/lib \
      -DCMAKE_INSTALL_PREFIX_TOOLCHAIN=$SYSROOT_PREFIX/sysroot/usr \
      -DCMAKE_PREFIX_PATH=$SYSROOT_PREFIX/sysroot/usr \
      $EXTRA_CMAKE_OPTS \
      ..

make
make_install
